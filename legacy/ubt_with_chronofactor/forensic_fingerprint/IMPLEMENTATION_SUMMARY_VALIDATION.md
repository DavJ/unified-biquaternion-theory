# Manifest Validation & Planck Model Hardening - Implementation Summary

**Date**: 2026-01-11  
**Author**: GitHub Copilot (with DavJ)  
**Branch**: `copilot/fix-manifest-and-harden-planck-handling`  
**Status**: ✅ COMPLETE

## Problem Statement

The forensic fingerprint pipeline needed enhanced validation to ensure:
1. Manifests contain hashes for the exact files used in each analysis run
2. Planck parameter/likelihood files are rejected when used as model spectrum input
3. Clear, actionable error messages guide users to correct file selection

## Solution Overview

### Part A: Manifest↔Arguments Consistency

**Implementation**: `run_real_data_cmb_comb.py`

After successful hash validation, the runner now:
1. Loads the manifest JSON
2. Extracts filenames from the manifest
3. Checks that all files passed to the run are in the manifest
4. Aborts with clear error if any file is missing

**Error Message Example**:
```
ERROR: Manifest validation succeeded but does not include files used by this run
Manifest: data/planck_pr3/manifests/planck_pr3_tt_manifest.json
Missing files:
  - model_spectrum.txt

To regenerate the manifest with the correct files, run:
  cd /path/to/repo
  python tools/data_provenance/hash_dataset.py obs.txt model.txt > manifest.json
```

### Part B: Planck Model Sanity Checks

**Implementation**: `loaders/planck.py` + `run_real_data_cmb_comb.py`

**Dual Protection Layer**:

1. **Runner Pre-flight (Filename Check)**:
   - Rejects files with 'minimum' or 'plikHM' in filename
   - Fast rejection before attempting to load
   - Clear error pointing to correct file types

2. **Loader Pre-flight (Content Check)**:
   - Reads first non-comment line
   - Detects '-log(Like)' or 'logLike' → raises ValueError
   - Counts data rows: < 50 rows → raises ValueError
   - Provides actionable suggestions for correct files

**Error Message Example**:
```
ERROR: Invalid Planck model file
File: base-plikHM-TTTEEE-minimum_R3.01.txt

This appears to be a Planck cosmological parameter file (likelihood minimum)
rather than a TT power spectrum model file.

Recommended files:
  1. Use the TT-full observation file as both obs and model (residual=0)
  2. Download the correct TT model spectrum from Planck Legacy Archive
  3. Use a theoretical ΛCDM spectrum generated by CAMB/CLASS

See forensic_fingerprint/RUNBOOK_REAL_DATA.md for guidance.
```

### Part C: Model Fallback Documentation

**Implementation**: `RUNBOOK_REAL_DATA.md`

**Model Fallback Hierarchy** (documented with code examples):

1. **Preferred**: Explicit theoretical model from CAMB/CLASS
   ```bash
   --planck_model path/to/theoretical_model.txt
   ```

2. **Fallback 1**: TT-full as both obs and model (noise analysis)
   ```bash
   --planck_obs COM_PowerSpect_CMB-TT-full_R3.01.txt \
   --planck_model COM_PowerSpect_CMB-TT-full_R3.01.txt
   ```

3. **Fallback 2**: No model specified (absolute spectrum)
   ```bash
   --planck_obs COM_PowerSpect_CMB-TT-full_R3.01.txt
   # (omit --planck_model, defaults to zeros)
   ```

## Files Modified

### Core Implementation (3 files)
1. **`run_real_data_cmb_comb.py`**: +142 lines
   - `validate_data_manifest()`: Exact file matching
   - Pre-flight parameter file rejection
   
2. **`loaders/planck.py`**: +65 lines
   - `_load_planck_text()`: Preflight sanity checks
   - `_skip_size_validation` parameter for tests

3. **`RUNBOOK_REAL_DATA.md`**: +60 lines
   - Planck model file selection guide
   - Manifest exact-file-matching documentation

### Tests (4 files)
4. **`test_manifest_validation_strict.py`**: NEW (2 tests)
5. **`test_planck_model_validation.py`**: NEW (4 tests)
6. **`test_runner_integration.py`**: NEW (3 tests)
7. **`test_forensic_fingerprint.py`**: UPDATED (19 tests passing)

### Demo & Tools (1 file)
8. **`demo_validation.py`**: NEW (interactive demonstration)

## Test Coverage

```
New Tests:               9 tests (all passing)
Updated Existing Tests:  25 tests (all passing)
Total Test Coverage:     34 tests ✅
```

### Test Breakdown:
- Manifest file matching: 2 tests
- Planck model validation: 4 tests
- End-to-end integration: 3 tests
- Data provenance: 6 tests
- Data loaders: 19 tests

## Key Features

### ✅ Manifest Validation Enforcement
- Validates manifest contains **exact** files used (not just any valid files)
- Clear error with regeneration command
- Works from any working directory

### ✅ Planck Model Hardening
- Rejects parameter/likelihood files (dual protection)
- Rejects tiny/corrupted files (< 50 rows)
- Actionable error messages
- Test-compatible with `_skip_size_validation` flag

### ✅ Documentation
- Model file selection guide (correct vs incorrect)
- Manifest generation best practices
- Fallback hierarchy with code examples
- Court-grade provenance workflow

## Security & Data Integrity

This implementation enhances data integrity through:

1. **Exact File Matching**: Manifests must contain precisely the files used, not approximate matches
2. **Wrong File Detection**: Catches common mistakes (parameter files, corrupted downloads)
3. **Clear Audit Trail**: Error messages document what was attempted and why it failed
4. **Court-Grade Provenance**: Ensures manifests are a true record of the analysis

## Usage Examples

### Correct Usage
```bash
# Generate manifest with exact files
python tools/data_provenance/hash_dataset.py \
    data/planck_pr3/raw/COM_PowerSpect_CMB-TT-full_R3.01.txt \
    data/planck_pr3/raw/theoretical_model.txt \
    > data/planck_pr3/manifests/planck_pr3_tt_manifest.json

# Run analysis with manifest
python forensic_fingerprint/run_real_data_cmb_comb.py \
    --planck_obs data/planck_pr3/raw/COM_PowerSpect_CMB-TT-full_R3.01.txt \
    --planck_model data/planck_pr3/raw/theoretical_model.txt \
    --planck_manifest data/planck_pr3/manifests/planck_pr3_tt_manifest.json
```

### What Gets Rejected
```bash
# ❌ Parameter file as model
--planck_model COM_PowerSpect_CMB-base-plikHM-minimum_R3.01.txt
# Error: File contains likelihood values, not a power spectrum

# ❌ Manifest missing model file
--planck_manifest manifest_with_only_obs.json
# Error: Manifest doesn't contain model.txt. Regenerate manifest.

# ❌ Tiny/corrupted file
--planck_model tiny_10row_file.txt
# Error: Only 10 rows (expected ~50-2500). Likely corrupted or wrong file.
```

## Backward Compatibility

✅ All existing functionality preserved  
✅ New validations are additive, not breaking  
✅ Tests updated to work with new rules  
✅ `_skip_size_validation` allows unit test flexibility

## Future Enhancements (Optional)

Potential future improvements:
1. Manifest version tracking
2. Automatic manifest regeneration suggestions with file paths detected
3. Validation for WMAP files (currently Planck-focused)
4. Integration with automated download scripts

## Conclusion

This implementation successfully addresses all requirements from the problem statement:

✅ Runner refuses "valid but mismatched" manifests  
✅ Planck loader refuses non-spectrum model files  
✅ Runbook updated with manifest generation best practices  
✅ All tests passing  
✅ Backward compatible  
✅ Well documented with examples

The forensic fingerprint pipeline now has robust validation to prevent common data integrity issues while maintaining clear, actionable error messages for users.

---

**Testing**: Run `python forensic_fingerprint/demo_validation.py` to see all features in action.

**Documentation**: See `forensic_fingerprint/RUNBOOK_REAL_DATA.md` for complete usage guide.
